---
title: "Econ 293 Final Project Analysis Report"
author: 
- Chris Lin, Joseph Son
- (clin17@stanford.edu, joeson@stanford.edu)
date: '`r Sys.Date()`'
output: pdf_document
---


```{r load_process_data, warning=FALSE, message=FALSE}
# Set up data and global variables
source("helpers.R")
source("load-data.R")
data_01 <- split_control_treated(0, 1, df, covariate_names)
data_02 <- split_control_treated(0, 2, df, covariate_names)
data_03 <- split_control_treated(0, 3, df, covariate_names)
NUM_TREES <- 1000
```

```{r hte_forests, warning=FALSE, message=FALSE}
# Estimate HTEs using forest-based learners
if (!file.exists("results/results_forests.rds")) {
  set.seed(123)
  results_forests_01 <- compare_forests(data_01$X, data_01$W, data_01$Y, data_01$ID, NUM_TREES)
  results_forests_01$compare <- "0 vs 1"
  
  results_forests_02 <- compare_forests(data_02$X, data_02$W, data_02$Y, data_02$ID, NUM_TREES)
  results_forests_02$compare <- "0 vs 2"
  
  results_forests_03 <- compare_forests(data_03$X, data_03$W, data_03$Y, data_03$ID, NUM_TREES)
  results_forests_03$compare <- "0 vs 3"
  
  results_forests <- Reduce(rbind, list(results_forests_01, 
                                        results_forests_02, 
                                        results_forests_03))
  saveRDS(results_forests, file = "results/results_forests.rds")
} else {
  results_forests <- readRDS(file = "results/results_forests.rds")
}
```

```{r hte_glmnets, warning=FALSE, message=FALSE}
# Estimate HTEs using ridge-based learners
if (!file.exists("results/results_glmnets.rds")) {
  set.seed(1234)
  results_glmnets_01 <- compare_glmnets(data_01$X, data_01$W, data_01$Y, data_01$ID, 10, 0, NUM_TREES)
  results_glmnets_01$compare <- "0 vs 1"
  
  results_glmnets_02 <- compare_glmnets(data_02$X, data_02$W, data_02$Y, data_02$ID, 10, 0, NUM_TREES)
  results_glmnets_02$compare <- "0 vs 2"
  
  results_glmnets_03 <- compare_glmnets(data_03$X, data_03$W, data_03$Y, data_03$ID, 10, 0, NUM_TREES)
  results_glmnets_03$compare <- "0 vs 3"
  
  results_glmnets <- Reduce(rbind, list(results_glmnets_01, 
                                        results_glmnets_02, 
                                        results_glmnets_03))
  saveRDS(results_glmnets, file = "results/results_glmnets.rds")
} else {
  results_glmnets <- readRDS(file = "results/results_glmnets.rds")
}
```

```{r best_hte_learners, warning=FALSE, message=FALSE}
# Combine all the results
hte_results <- rbind(results_forests, results_glmnets)

# Summarize the learner results
hte_summary_01 <- summarize_hte_results(hte_results, "0 vs 1")
hte_summary_02 <- summarize_hte_results(hte_results, "0 vs 2")
hte_summary_03 <- summarize_hte_results(hte_results, "0 vs 3")

# Find the best learners
hte_best_01 <- hte_results %>% 
  filter(compare == "0 vs 1") %>% 
  filter(learner == hte_summary_01$learner[hte_summary_01$MRL == min(hte_summary_01$MRL)])

hte_best_02 <- hte_results %>% 
  filter(compare == "0 vs 2") %>% 
  filter(learner == hte_summary_02$learner[hte_summary_02$MRL == min(hte_summary_02$MRL)])

hte_best_03 <- hte_results %>% 
  filter(compare == "0 vs 3") %>%
  filter(learner == hte_summary_03$learner[hte_summary_03$MRL == min(hte_summary_03$MRL)])
```

```{r ATE, warning=FALSE, message=FALSE}
calculate_ATE(data_01$df, data_02$df, data_03$df, 1)
calculate_ATE(data_01$df, data_02$df, data_03$df, 0.5)
```

